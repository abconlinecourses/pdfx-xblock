<!DOCTYPE html>
<div class="pdfx-block pdfjs-viewer" id="pdfx-block-${block_id}"
     data-block-type="pdfx"
     data-block-id="${block_id}"
     data-pdf-url="${pdf_url}"
     data-pdf-file-name="${pdf_file_name}"
     data-allow-download="${allow_download}"
     data-allow-annotation="${allow_annotation}"
     data-current-page="${current_page}"
     data-user-id="${user_id}"
     data-course-id="${course_id}"
     data-handler-url="${handler_url}"
     data-csrf-token="${csrf_token or ''}"
     data-saved-annotations="${saved_annotations_json}"
     data-drawing-strokes="${drawing_strokes_json}"
     data-highlights="${highlights_json}"
     data-marker-strokes="${marker_strokes_json}"
     data-text-annotations="${text_annotations_json}"
     data-shape-annotations="${shape_annotations_json}"
     data-note-annotations="${note_annotations_json}">

  <!-- CSRF token meta tag for JavaScript access -->
  % if csrf_token:
  <meta name="csrf-token" content="${csrf_token}">
  % endif

  <!-- PDF.js Viewer Container -->
  <div id="outerContainer-${block_id}" class="loadingInProgress">

    <!-- Main PDF.js Container -->
    <div id="mainContainer-${block_id}">
      <!-- Content Area: Sidebar + Viewer -->
      <div id="contentArea-${block_id}" class="contentArea">
        <!-- Secondary Toolbar for Annotations -->
        <div id="secondaryToolbar-${block_id}" class="secondaryToolbar hidden doorHangerRight">
          <div id="secondaryToolbarButtonContainer-${block_id}">
            % if allow_annotation:
            <!-- Highlight Tool with Parameters -->
            <div id="editorHighlight-${block_id}" class="toolbarButtonWithContainer">
              <button id="highlightTool-${block_id}" class="secondaryToolbarButton" type="button" role="radio" aria-expanded="false" aria-haspopup="true" aria-controls="editorHighlightParamsToolbar-${block_id}" title="Highlight">
                <span>Highlight</span>
              </button>
              <div class="editorParamsToolbar editorParamsToolbar-${block_id} hidden doorHangerRight" id="editorHighlightParamsToolbar-${block_id}">
                <div id="highlightParamsToolbarContainer-${block_id}" class="editorParamsToolbarContainer">
                  <div id="editorHighlightColorPicker-${block_id}" class="colorPicker">
                    <span class="editorParamsLabel">Highlight color</span>
                    <div id="highlightColorPickerButtons-${block_id}" class="colorPickerDropdown" role="listbox" aria-multiselectable="false" aria-orientation="horizontal">
                      <button id="highlightColorYellow-${block_id}" class="colorPickerButton" role="option" data-color="#FFFF98" title="Yellow" aria-selected="true" tabindex="0">
                        <span class="colorSwatch" style="background-color: #FFFF98;"></span>
                      </button>
                      <button id="highlightColorGreen-${block_id}" class="colorPickerButton" role="option" data-color="#53FFBC" title="Green" aria-selected="false" tabindex="0">
                        <span class="colorSwatch" style="background-color: #53FFBC;"></span>
                      </button>
                      <button id="highlightColorBlue-${block_id}" class="colorPickerButton" role="option" data-color="#80EBFF" title="Blue" aria-selected="false" tabindex="0">
                        <span class="colorSwatch" style="background-color: #80EBFF;"></span>
                      </button>
                      <button id="highlightColorPink-${block_id}" class="colorPickerButton" role="option" data-color="#FFCBE6" title="Pink" aria-selected="false" tabindex="0">
                        <span class="colorSwatch" style="background-color: #FFCBE6;"></span>
                      </button>
                      <button id="highlightColorRed-${block_id}" class="colorPickerButton" role="option" data-color="#FF4F5F" title="Red" aria-selected="false" tabindex="0">
                        <span class="colorSwatch" style="background-color: #FF4F5F;"></span>
                      </button>
                    </div>
                  </div>
                  <div id="editorHighlightThickness-${block_id}">
                    <label for="editorFreeHighlightThickness-${block_id}" class="editorParamsLabel">Thickness</label>
                    <div id="highlightThicknessPicker-${block_id}" class="thicknessPicker">
                      <input type="range" id="editorFreeHighlightThickness-${block_id}" class="editorParamsSlider" value="12" min="8" max="24" step="1" tabindex="0">
                    </div>
                  </div>
                  <div id="editorHighlightVisibility-${block_id}">
                    <div id="highlightDivider-${block_id}" class="divider"></div>
                    <div id="highlightToggler-${block_id}" class="toggler">
                      <label for="editorHighlightShowAll-${block_id}" class="editorParamsLabel">Show all</label>
                      <button id="editorHighlightShowAll-${block_id}" class="toggle-button" type="button" aria-pressed="true" tabindex="0"></button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Draw/Ink Tool with Parameters -->
            <div id="editorInk-${block_id}" class="toolbarButtonWithContainer">
              <button id="scribbleTool-${block_id}" class="secondaryToolbarButton" type="button" role="radio" aria-expanded="false" aria-haspopup="true" aria-controls="editorInkParamsToolbar-${block_id}" title="Draw">
                <span>Draw</span>
              </button>
              <div class="editorParamsToolbar editorParamsToolbar-${block_id} hidden doorHangerRight" id="editorInkParamsToolbar-${block_id}">
                <div id="inkParamsToolbarContainer-${block_id}" class="editorParamsToolbarContainer">
                  <div id="inkColorSetter-${block_id}" class="editorParamsSetter">
                    <label for="editorInkColor-${block_id}" class="editorParamsLabel">Color</label>
                    <input type="color" id="editorInkColor-${block_id}" class="editorParamsColor" value="#FF0000" tabindex="0">
                  </div>
                  <div id="inkThicknessSetter-${block_id}" class="editorParamsSetter">
                    <label for="editorInkThickness-${block_id}" class="editorParamsLabel">Thickness</label>
                    <input type="range" id="editorInkThickness-${block_id}" class="editorParamsSlider" value="1" min="1" max="20" step="1" tabindex="0">
                  </div>
                  <div id="inkOpacitySetter-${block_id}" class="editorParamsSetter">
                    <label for="editorInkOpacity-${block_id}" class="editorParamsLabel">Opacity</label>
                    <input type="range" id="editorInkOpacity-${block_id}" class="editorParamsSlider" value="1" min="0.05" max="1" step="0.05" tabindex="0">
                  </div>
                </div>
              </div>
            </div>

            <!-- Text Tool with Parameters -->
            <div id="editorFreeText-${block_id}" class="toolbarButtonWithContainer">
              <button id="textTool-${block_id}" class="secondaryToolbarButton" type="button" role="radio" aria-expanded="false" aria-haspopup="true" aria-controls="editorFreeTextParamsToolbar-${block_id}" title="Add Text">
                <span>Text</span>
              </button>
              <div class="editorParamsToolbar editorParamsToolbar-${block_id} hidden doorHangerRight" id="editorFreeTextParamsToolbar-${block_id}">
                <div id="textParamsToolbarContainer-${block_id}" class="editorParamsToolbarContainer">
                  <div id="textColorSetter-${block_id}" class="editorParamsSetter">
                    <label for="editorFreeTextColor-${block_id}" class="editorParamsLabel">Text color</label>
                    <input type="color" id="editorFreeTextColor-${block_id}" class="editorParamsColor" value="#0000ff" tabindex="0">
                  </div>
                  <div id="textFontSizeSetter-${block_id}" class="editorParamsSetter">
                    <label for="editorFreeTextFontSize-${block_id}" class="editorParamsLabel">Font size</label>
                    <input type="range" id="editorFreeTextFontSize-${block_id}" class="editorParamsSlider" value="12" min="5" max="100" step="1" tabindex="0">
                  </div>
                </div>
              </div>
            </div>

            <!-- Stamp Tool with Parameters -->
            <div id="editorStamp-${block_id}" class="toolbarButtonWithContainer">
              <button id="stampTool-${block_id}" class="secondaryToolbarButton" type="button" role="radio" aria-expanded="false" aria-haspopup="true" aria-controls="editorStampParamsToolbar-${block_id}" title="Add Image">
                <span>Stamp</span>
              </button>
              <div class="editorParamsToolbar editorParamsToolbar-${block_id} hidden doorHangerRight menu" id="editorStampParamsToolbar-${block_id}">
                <div id="stampMenuContainer-${block_id}" class="menuContainer">
                  <button id="editorStampAddImage-${block_id}" class="toolbarButton labeled" type="button" tabindex="0">
                    <span class="editorParamsLabel">Add Image</span>
                  </button>
                </div>
              </div>
            </div>

            <div id="toolbarSeparator-${block_id}" class="horizontalToolbarSeparator"></div>

            <!-- Clear Tool with Parameters -->
            <div id="editorClear-${block_id}" class="toolbarButtonWithContainer">
              <button id="clearAnnotations-${block_id}" class="secondaryToolbarButton" type="button" role="radio" aria-expanded="false" aria-haspopup="true" aria-controls="editorClearParamsToolbar-${block_id}" title="Clear Annotations">
                <span>Clear All</span>
              </button>
              <div class="editorParamsToolbar editorParamsToolbar-${block_id} hidden doorHangerRight menu" id="editorClearParamsToolbar-${block_id}">
                <div id="clearMenuContainer-${block_id}" class="menuContainer">
                  <button id="clearCurrentPage-${block_id}" class="toolbarButton labeled" type="button" tabindex="0">
                    <span class="editorParamsLabel">Clear Current Page</span>
                  </button>
                  <button id="clearEntirePdf-${block_id}" class="toolbarButton labeled" type="button" tabindex="0">
                    <span class="editorParamsLabel">Clear Entire PDF</span>
                  </button>
                </div>
              </div>
            </div>

            <!-- Manual Save Tool -->
            <div id="editorManualSave-${block_id}" class="toolbarButtonWithContainer">
              <button id="manualSave-${block_id}" class="secondaryToolbarButton manualSaveButton" type="button" title="Save Annotations Manually" tabindex="0">
                <span class="saveText">Save</span>
                <div id="saveStatus-${block_id}" class="saveStatusIndicator" title="Auto-save is enabled">
                  <div class="saveStatusDot"></div>
                </div>
              </button>
            </div>
            % endif
          </div>
        </div>

        <!-- Viewer Container -->
        <div id="viewerContainer-${block_id}">
          <div id="viewer-${block_id}" class="pdfViewer">
            <!-- PDF Pages will be dynamically inserted here by PDF.js -->
          </div>
        </div>
      </div>
      <!-- Main Toolbar -->
      <div class="toolbar">
        <div id="toolbarContainer-${block_id}" class="toolbarContainer">
          <div id="toolbarViewer-${block_id}" class="toolbarViewer">

            <!-- Left Section: Navigation Controls -->
            <div id="toolbarViewerLeft-${block_id}" class="toolbarSection toolbarLeft">
              <div class="toolbarGroup navigation-group">
                <button id="previous-${block_id}" class="toolbarButton navButton" title="Previous Page" tabindex="0">
                  <span class="buttonIcon">❮</span>
                  <span class="buttonLabel">Previous</span>
              </button>

                <button id="next-${block_id}" class="toolbarButton navButton" title="Next Page" tabindex="0">
                  <span class="buttonIcon">❯</span>
                  <span class="buttonLabel">Next</span>
                </button>
              </div>

              <div class="toolbarGroup page-group">
                <div class="pageControls">
                  <input type="number"
                         id="pageNumber-${block_id}"
                         class="toolbarField pageInput"
                         title="Page Number"
                         value="${current_page}"
                         size="4"
                         min="1"
                         tabindex="0">
                  <span class="pageSeparator">/</span>
                  <span id="numPages-${block_id}" class="toolbarLabel totalPages">--</span>
                </div>
              </div>
            </div>

            <!-- Center Section: Zoom Controls -->
            <div id="toolbarViewerMiddle-${block_id}" class="toolbarSection toolbarCenter">
              <div class="toolbarGroup zoom-group">
                <button id="zoomOut-${block_id}" class="toolbarButton zoomButton" title="Zoom Out" tabindex="0">
                  <span class="buttonIcon">−</span>
                  <span class="buttonLabel">Zoom Out</span>
              </button>

                <div class="zoomSelectContainer">
                  <select id="scaleSelect-${block_id}" class="toolbarField zoomSelect" title="Zoom Level" tabindex="0">
                    <option id="pageAutoOption-${block_id}" title="Automatic Zoom" value="auto">Auto</option>
                    <option id="pageActualOption-${block_id}" title="Actual Size" value="page-actual">100%</option>
                    <option id="pageFitOption-${block_id}" title="Fit Page" value="page-fit">Fit Page</option>
                    <option id="pageWidthOption-${block_id}" title="Fit Width" value="page-width" selected="selected">Fit Width</option>
                    <option id="customScaleOption-${block_id}" title="Custom Zoom" value="custom" disabled="disabled" hidden="true"></option>
                    <option title="50%" value="0.5">50%</option>
                    <option title="75%" value="0.75">75%</option>
                    <option title="100%" value="1">100%</option>
                    <option title="125%" value="1.25">125%</option>
                    <option title="150%" value="1.5">150%</option>
                    <option title="200%" value="2">200%</option>
                    <option title="300%" value="3">300%</option>
                    <option title="400%" value="4">400%</option>
                  </select>
                </div>

                <button id="zoomIn-${block_id}" class="toolbarButton zoomButton" title="Zoom In" tabindex="0">
                  <span class="buttonIcon">+</span>
                  <span class="buttonLabel">Zoom In</span>
                </button>
              </div>
            </div>

            <!-- Right Section: Action Controls -->
            <div id="toolbarViewerRight-${block_id}" class="toolbarSection toolbarRight">
              % if allow_annotation:
              <div class="toolbarGroup annotation-group">
                <button id="secondaryToolbarToggle-${block_id}" class="toolbarButton actionButton" title="Annotation Tools" tabindex="0">
                  <span class="buttonIcon">🔧</span>
                  <span class="buttonLabel">Tools</span>
              </button>
              </div>
              % endif

              % if allow_download:
              <div class="toolbarGroup download-group">
                <div id="editorDownload-${block_id}" class="toolbarButtonWithContainer">
                  <button id="download-${block_id}" class="toolbarButton actionButton" title="Download PDF" aria-expanded="false" aria-haspopup="true" aria-controls="editorDownloadParamsToolbar-${block_id}" tabindex="0">
                    <span class="buttonIcon">⬇</span>
                    <span class="buttonLabel">Download</span>
                  </button>
                  <div class="editorParamsToolbar editorParamsToolbar-${block_id} hidden doorHangerRight menu" id="editorDownloadParamsToolbar-${block_id}">
                    <div id="downloadMenuContainer-${block_id}" class="menuContainer">
                      <button id="downloadWithAnnotations-${block_id}" class="toolbarButton labeled" type="button" tabindex="0">
                        <span class="editorParamsLabel">Download with Annotations</span>
                      </button>
                      <button id="downloadWithoutAnnotations-${block_id}" class="toolbarButton labeled" type="button" tabindex="0">
                        <span class="editorParamsLabel">Download Original PDF</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              % endif
            </div>

          </div>
        </div>
      </div>
      <!-- Loading Bar -->
      <div id="loadingBar-${block_id}">
        <div class="progress"></div>
        <div class="glimmer"></div>
      </div>
    </div>
  </div>

  <!-- Error Wrapper -->
  <div id="errorWrapper-${block_id}" hidden="true">
    <div id="errorMessageLeft-${block_id}">
      <span id="errorMessage-${block_id}"></span>
      <button id="errorShowMore-${block_id}">More Information</button>
      <button id="errorShowLess-${block_id}" hidden="true">Less Information</button>
    </div>
    <div id="errorMessageRight-${block_id}">
      <button id="errorClose-${block_id}">Close</button>
    </div>
    <div class="clearBoth"></div>
    <textarea id="errorMoreInfo-${block_id}" hidden="true" readonly="readonly"></textarea>
  </div>

  <!-- Print Container (for PDF.js printing) -->
  <div id="printContainer-${block_id}"></div>
</div>
