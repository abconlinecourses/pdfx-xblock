<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Text Layer Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .test-button {
            background: #007cba;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #005a87;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>PDF XBlock Text Layer Test</h1>
        <p>This page tests the text layer functionality of the PDF XBlock to ensure text extraction and overlay work correctly.</p>

        <div class="test-section">
            <div class="test-title">1. PDF.js Availability Test</div>
            <button class="test-button" onclick="testPDFJSAvailability()">Check PDF.js</button>
            <div id="pdfjs-result" class="test-result"></div>
        </div>

        <div class="test-section">
            <div class="test-title">2. Text Layer Elements Test</div>
            <button class="test-button" onclick="testTextLayerElements()">Check Text Layers</button>
            <div id="textlayer-result" class="test-result"></div>
        </div>

        <div class="test-section">
            <div class="test-title">3. Debug Utilities Test</div>
            <button class="test-button" onclick="testDebugUtilities()">Check Debug Utils</button>
            <div id="debug-result" class="test-result"></div>
        </div>

        <div class="test-section">
            <div class="test-title">4. CSS Styles Test</div>
            <button class="test-button" onclick="testCSSStyles()">Check CSS</button>
            <div id="css-result" class="test-result"></div>
        </div>

        <div class="test-section">
            <div class="test-title">5. Manual Text Layer Creation Test</div>
            <button class="test-button" onclick="createTestTextLayer()">Create Test Layer</button>
            <button class="test-button" onclick="clearTestTextLayer()">Clear Test Layer</button>
            <div id="manual-result" class="test-result"></div>
            <div id="test-text-layer" style="position: relative; width: 400px; height: 200px; border: 1px solid #ccc; margin-top: 10px; background: #f9f9f9;"></div>
        </div>
    </div>

    <script>
        // Test PDF.js availability
        function testPDFJSAvailability() {
            const result = document.getElementById('pdfjs-result');

            try {
                const checks = {
                    pdfjsLib: typeof window.pdfjsLib !== 'undefined',
                    TextLayer: typeof window.pdfjsLib?.TextLayer === 'function',
                    Util: typeof window.pdfjsLib?.Util !== 'undefined',
                    version: window.pdfjsLib?.version || 'not available'
                };

                let html = '<div class="info">PDF.js Availability Check:</div>';
                html += `<div>• pdfjsLib: ${checks.pdfjsLib ? '✅' : '❌'}</div>`;
                html += `<div>• TextLayer: ${checks.TextLayer ? '✅' : '❌'}</div>`;
                html += `<div>• Util: ${checks.Util ? '✅' : '❌'}</div>`;
                html += `<div>• Version: ${checks.version}</div>`;

                if (checks.pdfjsLib) {
                    html += '<div class="success">PDF.js is available!</div>';
                } else {
                    html += '<div class="error">PDF.js is NOT available. Please load PDF.js library first.</div>';
                }

                result.innerHTML = html;

            } catch (error) {
                result.innerHTML = `<div class="error">Error checking PDF.js: ${error.message}</div>`;
            }
        }

        // Test text layer elements
        function testTextLayerElements() {
            const result = document.getElementById('textlayer-result');

            try {
                const textLayers = document.querySelectorAll('[id^="text-layer-"], .text-layer, .textLayer');
                const pdfContainers = document.querySelectorAll('[id^="pdf-container-"], .pdf-container');

                let html = '<div class="info">Text Layer Elements Check:</div>';
                html += `<div>• Text layers found: ${textLayers.length}</div>`;
                html += `<div>• PDF containers found: ${pdfContainers.length}</div>`;

                if (textLayers.length > 0) {
                    html += '<div class="success">Text layer elements found!</div>';
                    textLayers.forEach((layer, index) => {
                        const spans = layer.querySelectorAll('span');
                        html += `<div>  - Layer ${index + 1}: ${layer.id || 'no ID'} (${spans.length} spans)</div>`;
                    });
                } else {
                    html += '<div class="error">No text layer elements found.</div>';
                }

                result.innerHTML = html;

            } catch (error) {
                result.innerHTML = `<div class="error">Error checking text layers: ${error.message}</div>`;
            }
        }

        // Test debug utilities
        function testDebugUtilities() {
            const result = document.getElementById('debug-result');

            try {
                const hasDebugUtils = typeof window.PDFX_TEXT_DEBUG !== 'undefined';
                const hasLegacyDebug = typeof window.pdfxDebug !== 'undefined';
                const debugMode = window.PDFX_DEBUG;

                let html = '<div class="info">Debug Utilities Check:</div>';
                html += `<div>• PDFX_TEXT_DEBUG: ${hasDebugUtils ? '✅' : '❌'}</div>`;
                html += `<div>• Legacy pdfxDebug: ${hasLegacyDebug ? '✅' : '❌'}</div>`;
                html += `<div>• Debug mode: ${debugMode ? '✅ Enabled' : '❌ Disabled'}</div>`;

                if (hasDebugUtils) {
                    html += '<div class="success">Enhanced debug utilities are available!</div>';

                    // Test debug functions
                    const debugFunctions = [
                        'checkPDFJSAvailability',
                        'checkTextLayerStatus',
                        'testTextExtraction',
                        'forceTextLayerRefresh',
                        'createTextLayer',
                        'makeTextLayerVisible',
                        'hideTextLayer',
                        'addDebugButtons'
                    ];

                    html += '<div>Available debug functions:</div>';
                    debugFunctions.forEach(func => {
                        const available = typeof window.PDFX_TEXT_DEBUG[func] === 'function';
                        html += `<div>  - ${func}: ${available ? '✅' : '❌'}</div>`;
                    });
                } else {
                    html += '<div class="error">Debug utilities not loaded.</div>';
                }

                result.innerHTML = html;

            } catch (error) {
                result.innerHTML = `<div class="error">Error checking debug utilities: ${error.message}</div>`;
            }
        }

        // Test CSS styles
        function testCSSStyles() {
            const result = document.getElementById('css-result');

            try {
                // Create a test element to check CSS
                const testElement = document.createElement('div');
                testElement.className = 'text-layer';
                testElement.id = 'test-text-layer-css';
                testElement.style.position = 'absolute';
                testElement.style.top = '-1000px';
                document.body.appendChild(testElement);

                const computedStyle = window.getComputedStyle(testElement);

                let html = '<div class="info">CSS Styles Check:</div>';
                html += `<div>• Position: ${computedStyle.position}</div>`;
                html += `<div>• Opacity: ${computedStyle.opacity}</div>`;
                html += `<div>• Pointer Events: ${computedStyle.pointerEvents}</div>`;
                html += `<div>• Z-Index: ${computedStyle.zIndex}</div>`;
                html += `<div>• User Select: ${computedStyle.userSelect}</div>`;

                // Check if styles are applied correctly
                const isCorrect =
                    computedStyle.position === 'absolute' &&
                    computedStyle.opacity === '1' &&
                    computedStyle.pointerEvents === 'auto';

                if (isCorrect) {
                    html += '<div class="success">CSS styles are correctly applied!</div>';
                } else {
                    html += '<div class="error">CSS styles may have issues.</div>';
                }

                // Clean up
                document.body.removeChild(testElement);

                result.innerHTML = html;

            } catch (error) {
                result.innerHTML = `<div class="error">Error checking CSS: ${error.message}</div>`;
            }
        }

        // Create test text layer
        function createTestTextLayer() {
            const result = document.getElementById('manual-result');
            const container = document.getElementById('test-text-layer');

            try {
                // Clear existing content
                container.innerHTML = '';

                // Create a mock text layer
                const textLayer = document.createElement('div');
                textLayer.className = 'text-layer';
                textLayer.id = 'manual-test-text-layer';
                textLayer.style.position = 'absolute';
                textLayer.style.top = '0';
                textLayer.style.left = '0';
                textLayer.style.width = '100%';
                textLayer.style.height = '100%';
                textLayer.style.pointerEvents = 'auto';
                textLayer.style.opacity = '1';
                textLayer.style.zIndex = '3';

                // Create test text spans
                const testTexts = [
                    { text: 'Sample Text 1', x: 20, y: 30 },
                    { text: 'Sample Text 2', x: 20, y: 60 },
                    { text: 'Sample Text 3', x: 20, y: 90 },
                    { text: 'Selectable Text', x: 20, y: 120 },
                    { text: 'Interactive Text', x: 20, y: 150 }
                ];

                testTexts.forEach((item, index) => {
                    const span = document.createElement('span');
                    span.textContent = item.text;
                    span.className = 'pdfx-text-span';
                    span.style.position = 'absolute';
                    span.style.left = `${item.x}px`;
                    span.style.top = `${item.y}px`;
                    span.style.fontSize = '14px';
                    span.style.fontFamily = 'Arial, sans-serif';
                    span.style.color = 'transparent';
                    span.style.userSelect = 'text';
                    span.style.cursor = 'text';
                    span.style.pointerEvents = 'auto';
                    span.setAttribute('data-text-index', index);

                    textLayer.appendChild(span);
                });

                container.appendChild(textLayer);

                result.innerHTML = `
                    <div class="success">Test text layer created successfully!</div>
                    <div>• Created ${testTexts.length} text spans</div>
                    <div>• Try selecting text in the test area above</div>
                    <div>• Text should be selectable but transparent</div>
                `;

            } catch (error) {
                result.innerHTML = `<div class="error">Error creating test text layer: ${error.message}</div>`;
            }
        }

        // Clear test text layer
        function clearTestTextLayer() {
            const result = document.getElementById('manual-result');
            const container = document.getElementById('test-text-layer');

            try {
                container.innerHTML = '';
                result.innerHTML = '<div class="info">Test text layer cleared.</div>';
            } catch (error) {
                result.innerHTML = `<div class="error">Error clearing test text layer: ${error.message}</div>`;
            }
        }

        // Auto-run basic tests on page load
        window.addEventListener('DOMContentLoaded', function() {
            console.log('PDF XBlock Text Layer Test Page Loaded');

            // Check if we're in the context of the PDF XBlock
            setTimeout(() => {
                testPDFJSAvailability();
                testTextLayerElements();
                testDebugUtilities();
                testCSSStyles();
            }, 1000);
        });
    </script>
</body>
</html>